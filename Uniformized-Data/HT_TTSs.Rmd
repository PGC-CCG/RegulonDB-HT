---
title: "HT terminators"
author: "Claire Rioualen"
date: '`r Sys.Date()`'
output:
 html_document:
   fig_caption: yes
   highlight: zenburn
   self_contained: yes
   theme: cerulean
   toc: yes
   toc_depth: 5
   toc_float: yes
   number_sections: no
   code_folding: hide


---
<style type="text/css">

body{ /* Normal  */
      font-size: 14px;
  }
</style>


```{r setup, include = FALSE}
setwd("/Users/rioualen/Google Drive/Work/Ecoli_mapping_project/Feature_set")
ht_collection_dir <- "~/Dropbox/HT-Collections"

knitr::opts_knit$set(root.dir = ht_collection_dir)
knitr::opts_chunk$set(echo = TRUE, include = TRUE, warning = FALSE, message = FALSE, cache = FALSE, eval = TRUE, fig.width = 12, fig.height = 9, fig.align = 'center')
```


```{r libs-n-functions}
library(ggplot2)
library(dplyr)
library(DT)
library(gridExtra)
library(readxl)
library(tidyr)

## Pending proper installation
devtools::load_all("~/Desktop/Git/EcoliGenes")

concat_uniq <- function(x, sep = ","){
  paste0(unique(na.omit(x)), collapse = sep)
}

check_dup <- function(df){
  test_dup <- df %>%
    mutate(coords = paste0(start, "_", stop, "_", strand)) %>%
    group_by(coords) %>%
    summarise(count = n(), 
              across(where(is.character), concat_uniq, sep = "_"),
              across(where(is.numeric), concat_uniq, sep = "_"),
              .groups = 'drop') %>%
    arrange(desc(count)) %>%
    filter(count>1) 
  test_dup
}

## wrapper function to remove commented rows from excel sheets
read_excel_cm <- function(file, sheet, comment.char = "#"){
  tab <- read_excel(file, sheet, col_names = F)
  skip_rows <- grep(paste0("^", comment.char), unlist(c(tab[,1])))
  if(length(skip_rows) > 0) tab <- read_excel(file, sheet, skip = max(skip_rows))
  return(tab)
}

```

# Transcription terminators

## Format 

Here, a **dataset** is defined by a combination of **PMID and experimental condition**. 

TTSs are collected from a variety of sources and processed to produce uniform bed-like dataset files with the following fields: 

* **chromosome:** NC_000913.3
* **start:** Left genomic position. If not reported, will be the same as `term_pos`
* **stop:**  Right genomic position. If not reported, will be the same as `term_pos`
* **id:** Unique TSS ID 
* **term_pos:** Terminal position reported by authors
* **strand:** TTS strand reported by authors

## Metadata

```{r metadata-file}
metadata_file <- "DatasetCollection-Terminators-HT_v0.3.xlsx"
```

* Metadata file version used: **`r metadata_file`**

```{r read-metadata}
## Read metadata table, filter out datasets that don't have a condition associated
ht_term_metadata <- read_excel_cm(paste0(ht_collection_dir, "/coleccion_TTS/metadata/", metadata_file), sheet = "TTS_v0.2") %>%
  dplyr::rename(dataset_id = "Dataset ID",
                pmid = "PMID",
                author = "Authors",
                condition = "Growth Conditions Experimental",
                file = "Dataset File Name") %>%
  dplyr::select(dataset_id, pmid, author, condition) %>%
  dplyr::filter(!is.na(condition))

## Make dataset list from table
ht_term_dataset_list <- setNames(split(ht_term_metadata, seq(nrow(ht_term_metadata))), ht_term_metadata$dataset_id)
```

```{r display-metadata}
## Display datasets
DT1 <- DT::datatable(ht_term_metadata, options = list(dom = '', pageLength = 20, autoWidth = TRUE, columnDefs = list(list(width = '200px', targets = c(3, 4)))))
DT1
```

## Datasets per author {.tabset}

This part is customized depending on the originally published files. Since those files are formatted each in their own way, this part is partly manual and should be modified carefully.

### Conway

Reference article: [Conway et al., 2014](https://doi.org/10.1128/mbio.01442-14)

Conditions:

* Exponential phase

Notes:

* Genome coordinates were converted from version U00096.2 to version U00096.3 [here](https://biocyc.org/ECOLI/map-seq-coords-form?chromosome=COLI-K12)

```{r ht-term-conway}
## Code executed just once, in order to export promoters coordinates and convert them through Ecocyc
##---------------------------------------------------------------------------------
# file <- "inline-supplementary-material-6 (terminators).xlsx"
# read_excel(paste0(ht_collection_dir, "/coleccion_TTS/author_files/", file), skip = 1) %>%
#   dplyr::mutate(term_pos = as.numeric(gsub("^[A-Z]{1,2}-{1}", "", Term)), strand = Strand) %>%
#   dplyr::select(term_pos, strand) %>%
#   write.table(file = paste0(ht_collection_dir, "/coleccion_TTS/author_files/intermediate_files/Conway_TTS_parsed.tsv"), sep = "\t", quote = F, col.names = T, row.names = F)

## Conversion Conway_TTS_parsed.tsv -> Conway_TTS_parsed_converted.tsv

TR0003 <- read.delim(paste0(ht_collection_dir, "/coleccion_TTS/author_files/intermediate_files/Conway_TTS_parsed_converted.tsv"), comment.char = "#", header = T) %>%
  dplyr::distinct()

```


### Ju 

Reference article: [Ju et al., 2019](https://doi.org/10.1038/s41564-019-0500-z)

Conditions:

* exponential phase
* stationary phase


```{r ht-term-ju}
##---------------------------------------------------------------------------------
file <- "Ju et al_Supplementary Table 2.xlsx"
TR0001_TR0002 <- read_excel(paste0(ht_collection_dir, "/coleccion_TTS/author_files/source_files/", file), skip = 2) %>%
  dplyr::rename(term_pos = TTS_position, 
                strand = TTS_strand) %>%
  dplyr::distinct()

##---------------------------------------------------------------------------------
TR0001 <- TR0001_TR0002 %>%
  dplyr::filter(!is.na(log_TTS)) %>%
  dplyr::select(strand, term_pos)

TR0002 <- TR0001_TR0002 %>%
  dplyr::filter(!is.na(stationary_TTS)) %>%
  dplyr::select(strand, term_pos)

```

### Yan

Reference article: [Yan et al., 2018](10.1038/s41467-018-05997-6)

Conditions:

* M9 (minimal growth medium)
* Rich (rich growth medium)

Notes:

* Two types of TU termination are reported for each condition: detected TTS or longest read end. The latter was not included.

```{r yan-term-ht}
##---------------------------------------------------------------------------------
TR0004 <- read.table(paste0(ht_collection_dir, "/coleccion_TUs/author_files/source_files/M9_RegulonDB_TU_definedEnd.txt"), stringsAsFactors = F) %>% 
  dplyr::rename(start = V1, stop = V2, strand = V3) %>%
  dplyr::mutate(term_pos = ifelse(strand == "-", start, stop)) %>%
  dplyr::select(strand, term_pos) %>%
  dplyr::distinct()


##---------------------------------------------------------------------------------
TR0005 <- read.table(paste0(ht_collection_dir, "/coleccion_TUs/author_files/source_files/Rich_RegulonDB_TU_definedEnd.txt"), stringsAsFactors = F) %>% 
  dplyr::rename(start = V1, stop = V2, strand = V3) %>%
  dplyr::mutate(term_pos = ifelse(strand == "-", start, stop)) %>%
  dplyr::select(strand, term_pos) %>%
  dplyr::distinct()

```

## Uniformization

This part assumes that the specificities of each individual dataset were dealt with previously. It generates unique IDs for terminators and writes one file per dataset.

```{r write-tts-files}
term_dir <- paste0(ht_collection_dir, "/coleccion_TTS/uniformized_data")
datasets_list <- list()

## Process all datasets automatically
for(ds_id in names(ht_term_dataset_list)) {
  df <- get(ds_id) %>%
    dplyr::mutate(id = paste0("TTS_", ds_id, "_", dplyr::row_number()),
                  start = term_pos,
                  stop = term_pos,
                  chromosome = "NC_000913.3") %>%
    dplyr::arrange(start)


  write.table(df %>% dplyr::select(chromosome, start, stop, id, term_pos, strand), file = paste0(term_dir, "/", ds_id, ".tsv"), sep = "\t", quote = F, col.names = T, row.names = F)
  
  assign(ds_id, df)
  
  datasets_list[[ds_id]] <- df

}

```

* Write a summary file for TU datasets

```{r write-tu-table}
ht_term_stats <- ht_term_metadata %>%
  dplyr::rowwise() %>%
  dplyr::mutate(term_number = nrow(get(dataset_id))) %>%
  dplyr::select(dataset_id, pmid, author, condition, term_number)

write.table(ht_term_stats, file = paste0(term_dir, "/TTS_datasets.tsv"), sep = "\t", quote = F, col.names = T, row.names = F)
```

## Results

### Summary of datasets

**Note: since terminators from the Ju paper couldn't be distinguished, they were kept together, which is why the number is the same. (same goes for TUs of the same source)**

```{r stats-term}
DT2 <- DT::datatable(ht_term_stats, options = list(dom = '', pageLength = 20)) %>% DT::formatRound('term_number', digits=0)
DT2


total_tts <- nrow(bind_rows(datasets_list))

```

Total objects: `r total_tts`

### Distributions

#### Number of terminators per dataset

```{r fig-stats-term-1}
ht_term_stats_legends <- ht_term_stats  %>%
  dplyr::mutate(first_author = str_split(author, ",")[[1]][1])

ggplot(ht_term_stats_legends, aes(x = dataset_id, y = term_number, fill = first_author)) +
  geom_col(size = 2) +
  # scale_fill_manual(values = RColorBrewer::brewer.pal(length(unique(ht_term_stats$author)), "Pastel2")) +
  theme(axis.text.x = element_text(angle = 45, hjust=1), text = element_text(size = 14)) +
  ylab("Number of terminators") +
  xlab("Dataset ID") +
  labs(title = "Number of terminators per dataset")
  
```

